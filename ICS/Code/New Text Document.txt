using System;
using System.Data;
using System.Windows.Forms;

namespace RailwayReservationWin
{
    public class RegisterForm : Form
    {
        private Label lblName;
        private TextBox txtName;
        private Label lblEmail;
        private TextBox txtEmail;
        private Label lblPhone;
        private TextBox txtPhone;
        private Label lblPassword;
        private TextBox txtPassword;
        private Label lblDob;
        private DateTimePicker dtpDob;
        private Label lblGender;
        private ComboBox cmbGender;
        private Button btnRegister;

        private DataAccess db = new DataAccess();

        public RegisterForm()
        {
            this.Text = "Register New User";
            this.Width = 350;
            this.Height = 400;
            this.StartPosition = FormStartPosition.CenterScreen;

            lblName = new Label { Text = "Name:", Left = 30, Top = 30, Width = 100 };
            txtName = new TextBox { Left = 140, Top = 28, Width = 160 };

            lblEmail = new Label { Text = "Email:", Left = 30, Top = 70, Width = 100 };
            txtEmail = new TextBox { Left = 140, Top = 68, Width = 160 };

            lblPhone = new Label { Text = "Phone:", Left = 30, Top = 110, Width = 100 };
            txtPhone = new TextBox { Left = 140, Top = 108, Width = 160 };

            lblPassword = new Label { Text = "Password:", Left = 30, Top = 150, Width = 100 };
            txtPassword = new TextBox { Left = 140, Top = 148, Width = 160, PasswordChar = '*' };

            lblDob = new Label { Text = "Date of Birth:", Left = 30, Top = 190, Width = 100 };
            dtpDob = new DateTimePicker { Left = 140, Top = 188, Width = 160, Format = DateTimePickerFormat.Short };

            lblGender = new Label { Text = "Gender:", Left = 30, Top = 230, Width = 100 };
            cmbGender = new ComboBox { Left = 140, Top = 228, Width = 160, DropDownStyle = ComboBoxStyle.DropDownList };
            cmbGender.Items.AddRange(new string[] { "male", "female", "other" });

            btnRegister = new Button { Text = "Register", Left = 140, Top = 280, Width = 160 };
            btnRegister.Click += BtnRegister_Click;

            this.Controls.Add(lblName);
            this.Controls.Add(txtName);
            this.Controls.Add(lblEmail);
            this.Controls.Add(txtEmail);
            this.Controls.Add(lblPhone);
            this.Controls.Add(txtPhone);
            this.Controls.Add(lblPassword);
            this.Controls.Add(txtPassword);
            this.Controls.Add(lblDob);
            this.Controls.Add(dtpDob);
            this.Controls.Add(lblGender);
            this.Controls.Add(cmbGender);
            this.Controls.Add(btnRegister);
        }

        private void BtnRegister_Click(object sender, EventArgs e)
        {
            // Validation
            if (string.IsNullOrWhiteSpace(txtName.Text) ||
                string.IsNullOrWhiteSpace(txtEmail.Text) ||
                string.IsNullOrWhiteSpace(txtPhone.Text) ||
                string.IsNullOrWhiteSpace(txtPassword.Text))
            {
                MessageBox.Show("Please fill all required fields (Name, Email, Phone, Password).", "Validation Error", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }
            if (cmbGender.SelectedIndex == -1)
            {
                MessageBox.Show("Please select Gender.", "Validation Error", MessageBoxButtons.OK, MessageBoxIcon.Warning);
                return;
            }

            // Call ADO.NET registration
            DataTable dt = db.ExecuteTable("sp_registeruser",
                new System.Data.SqlClient.SqlParameter("@name", txtName.Text.Trim()),
                new System.Data.SqlClient.SqlParameter("@email", txtEmail.Text.Trim()),
                new System.Data.SqlClient.SqlParameter("@phone", txtPhone.Text.Trim()),
                new System.Data.SqlClient.SqlParameter("@password", txtPassword.Text.Trim()),
                new System.Data.SqlClient.SqlParameter("@dateofbirth", dtpDob.Value.Date),
                new System.Data.SqlClient.SqlParameter("@gender", cmbGender.SelectedItem.ToString())
            );

            if (dt.Rows.Count > 0)
            {
                int success = Convert.ToInt32(dt.Rows[0]["success"]);
                string message = dt.Rows[0]["message"].ToString();
                if (success == 1)
                {
                    MessageBox.Show("Registration successful! Please login.", "Success", MessageBoxButtons.OK, MessageBoxIcon.Information);
                    this.Close();
                }
                else
                {
                    MessageBox.Show(message, "Registration Failed", MessageBoxButtons.OK, MessageBoxIcon.Error);
                }
            }
            else
            {
                MessageBox.Show("Registration failed. Please try again.", "Error", MessageBoxButtons.OK, MessageBoxIcon.Error);
            }
        }
    }
}